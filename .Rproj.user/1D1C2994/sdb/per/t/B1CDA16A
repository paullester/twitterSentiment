{
    "collab_server" : "",
    "contents" : "#################################################\n#########Sentiment Analysis on Tweets############\n################# Paul Le Ster ##################\n#################################################\n#The purpose of this code is to build a simple sentiment analysis classifier\n#and how sentiment fluctuated by month\n#I use  the tidytext package developed by Julia Silge and David Robinson,\n#I'm borrow heavily frmo the code in this article (which served as inspiration) http://varianceexplained.org/r/trump-tweets/\n\nlibrary(dplyr)\nlibrary(purrr)\nlibrary(twitteR)\nlibrary(ggplot2)\nlibrary(stringr)\nlibrary(tidytext)\nlibrary(tidyr)\nlibrary(lubridate)\nlibrary(scales)\nlibrary(ggthemes)\nlibrary(extrafont)\nlibrary(splitstackshape)\n#library(plyr)\nlibrary(dplyr)\n\n\nsource(\"sentiment_helper.R\")\n\n\n################################\n#Important note: In order to show a strong difference, I am filtering DJT's tweets to show only those posted from his Android\n#According to analysis done here http://varianceexplained.org/r/trump-tweets/, they are much more likely to be direct from DJT\n#To see tweets directly from Hillary, I am filtering for those ending in \"-H\"\n#################################\n\n################################\n#GET RAW TWEETS\n#Tweets are from Trump twitter archive\n#hillary tweets are from allmytweets.com\n#Pulled by copy and pasting into csv <- TODO: do through web scraping next time\n#################################\n\n\n#\n#Trump\n#\n\n#Try for all tweets\ndjt.raw <- read.csv(\"rawtweetsv2.csv\", header = FALSE, as.is=TRUE)\ndjt.df <- data.frame(djt.raw)\n\n#initial split\ndjt.df<-cSplit(djt.df, 'V1', sep=\"\\xca\", type.convert=FALSE)\nkeeps <- c(\"V1_1\", \"V1_2\",\"V1_3\")\n\ndevice <- NULL\nfor(i in 1:nrow(djt.df)) {\n  device <- c(source,extractSource(djt.df[i,\"V1_3\"]))\n}\ndjt.df$device = device\ndjt.df = subset(djt.df, select = -c(V1_3,V1_4,V1_5,V1_6) )\n\n#Hacky Date fix\ndjt.df$dateraw = substr(djt.df$V1_1,1,nchar(djt.df$V1_1)-12)\ndjt.df$dateraw = trimws(djt.df$dateraw)\ndjt.df$month = substr(djt.df$dateraw,1,3)\ndjt.df$day = substr(djt.df$dateraw,5,6)\ndjt.df$day = gsub(',','',djt.df$day)\ndjt.df$year = substr(djt.df$V1_1,nchar(djt.df$dateraw)-3,nchar(djt.df$dateraw))\ndjt.df$date <- as.Date(paste(djt.df$day,djt.df$month,djt.df$year, sep=\"\"), \"%d%b%Y\")\ndjt.df = subset(djt.df, select = -c(V1_1,day,month,year,dateraw) )\n\n#add source column\ndjt.df$source = \"Trump\"\nnames(djt.df)[names(djt.df)==\"V1_2\"] <- \"tweet\"\n#subset to match dates july 20th to nov 9th\ndjt.df.trim = djt.df[date>=\"2016-07-19\" & date<=\"2016-11-10\"]\ndjt.df.trim = djt.df.trim[device==\"Android\"]\ndjt.df.trim = subset(djt.df.trim, select = -c(device) )\n\n#\n#Hillary\n#\n\n#Try for all tweets\nhrc.raw <- read.csv(\"hillary_tweets_jul20onwards_raw.csv\", header = FALSE, as.is=TRUE)\nhrc.df <- data.frame(hrc.raw)\n\nhrc.df$tweet = substr(hrc.df$V1,1,nchar(hrc.df$V1)-12)\n\n#Hacky Date fix\nhrc.df$dateraw = substr(hrc.df$V1,nchar(hrc.df$V1)-12,nchar(hrc.df$V1))\nhrc.df$dateraw = trimws(hrc.df$dateraw)\nhrc.df$month = substr(hrc.df$dateraw,1,3)\nhrc.df$day = substr(hrc.df$dateraw,5,6)\nhrc.df$year = substr(hrc.df$dateraw,nchar(hrc.df$dateraw)-3,nchar(hrc.df$dateraw))\nhrc.df$date <- as.Date(paste(hrc.df$day,hrc.df$month,hrc.df$year, sep=\"\"), \"%d%b%Y\")\nhrc.df = subset(hrc.df, select = -c(V1,day,month,year,dateraw) )\n\nhrc.df$source = \"Hillary\"\n\n#subset to match dates july 20th to nov 9th\nhrc.df.trim  <- subset(hrc.df, date > \"2016-07-19\" & date < \"2016-11-10\")\n\nhrc.df.trim$fromHill = str_detect(hrc.df.trim$tweet, \"-H\") \n\nhrc.df.trim2<-subset(hrc.df.trim, fromHill == TRUE)\n\n#hrc.df.trim$fromHill = str_detect(hrc.df.trim$tweet, \"-Hillary\")\n                                              \n#combine tweets\ntweets.df <- rbind(hrc.df.trim2, djt.df.trim)\n\n#add in an id column\n\ntweets.df$id<-seq.int(nrow(tweets.df))\n\n###########################\n##Clean text data\n##########################\n\n#remove tweets startign with \" -> indication of a manual retweet\ncolnames(tweets.df)[1] <- \"text\"\nreg <- \"([^A-Za-z\\\\d#@']|'(?![A-Za-z\\\\d#@]))\"\ntweet.words <- tweets.df %>%\n  filter(!str_detect(text, '^\"')) %>%\n  mutate(text = str_replace_all(text, \"https://t.co/[A-Za-z\\\\d]+|&amp;\", \"\")) %>%\n  unnest_tokens(word, text, token = \"regex\", pattern = reg) %>%\n  filter(!word %in% stop_words$word,\n         str_detect(word, \"[a-z]\"))\n\n\ndjt_hrc_comparison_ratio <- tweet.words %>%\n  count(word, source) %>%\n  filter(sum(n) >= 5) %>%\n  spread(source, n, fill = 0) %>%\n  ungroup() %>%\n  mutate_each(funs((. + 1) / sum(. + 1)), -word) %>%\n  mutate(logratio = log2(Trump / Hillary)) %>%\n  arrange(desc(logratio))\n\ndjt_hrc_comparison_ratio %>%\n  group_by(logratio > 0) %>%\n  top_n(15, abs(logratio)) %>%\n  ungroup() %>%\n  mutate(word = reorder(word, logratio)) %>%\n  ggplot(aes(word, logratio, fill = logratio < 0)) +\n  geom_bar(stat = \"identity\") +\n  coord_flip() +\n  ylab(\"Trump / Hillary log ratio\") +\n  scale_fill_manual(name = \"\", labels = c(\"Trump\", \"Hillary\"),\n                    values = c(\"red\", \"lightblue\"))\n\n\n\n\nnrc <- sentiments %>%\n  filter(lexicon == \"nrc\") %>%\n  dplyr::select(word, sentiment)\n\nnrc\n\nsources <- tweet.words %>%\n  group_by(source) %>%\n  mutate(total_words = n()) %>%\n  ungroup() %>%\n  distinct(id, source, total_words)\n\nby_source_sentiment <- tweet.words %>%\n  inner_join(nrc, by = \"word\") %>%\n  count(sentiment, id) %>%\n  ungroup() %>%\n  complete(sentiment, id, fill = list(n = 0)) %>%\n  inner_join(sources) %>%\n  group_by(source, sentiment, total_words) %>%\n  summarize(words = sum(n)) %>%\n  ungroup()\n\nhead(by_source_sentiment)\n\n\nlibrary(broom)\n\ndjt_hrc_comparison_ratio %>%\n  inner_join(nrc, by = \"word\") %>%\n  filter(!sentiment %in% c(\"positive\", \"negative\")) %>%\n  mutate(sentiment = reorder(sentiment, -logratio),\n         word = reorder(word, -logratio)) %>%\n  group_by(sentiment) %>%\n  top_n(10, abs(logratio)) %>%\n  ungroup() %>%\n  ggplot(aes(word, logratio, fill = logratio < 0)) +\n  facet_wrap(~ sentiment, scales = \"free\", nrow = 2) +\n  geom_bar(stat = \"identity\") +\n  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +\n  labs(x = \"\", y = \"Trump / Hillary log ratio\") +\n  scale_fill_manual(name = \"\", labels = c(\"Trump\", \"Hillary\"),\n                    values = c(\"red\", \"lightblue\"))\n\n\n",
    "created" : 1485884152025.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3678520139",
    "id" : "B1CDA16A",
    "lastKnownWriteTime" : 1485969467,
    "last_content_update" : 1485969467186,
    "path" : "~/datascience/sentiment/sentiment_tweet.R",
    "project_path" : "sentiment_tweet.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}